#include <exploit/dfu.h>

bool dfu_check_status(const usb_handle_t *handle, uint8_t status, uint8_t state) {
	struct {
		uint8_t status, poll_timeout[3], state, str_idx;
	} dfu_status;
	transfer_ret_t transfer_ret;

	return send_usb_control_request(handle, 0xA1, DFU_GETSTATUS, 0, 0, &dfu_status, sizeof(dfu_status), &transfer_ret)
    && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == sizeof(dfu_status)
    && dfu_status.status == status && dfu_status.state == state;
}

bool dfu_device_set_await_reset(const usb_handle_t *handle) {
	transfer_ret_t transfer_ret;

	return send_usb_control_request_no_data(handle, 0x21, DFU_DNLOAD, 0, 0, 0, &transfer_ret)
    && transfer_ret.ret == USB_TRANSFER_OK && transfer_ret.sz == 0
    && dfu_check_status(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST_SYNC)
    && dfu_check_status(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST)
    && dfu_check_status(handle, DFU_STATUS_OK, DFU_STATE_MANIFEST_WAIT_RESET);
}

int dfu_serial_number_get_cpid(char *serial) {
	char *cpid = strstr(serial, "CPID:");
	if (cpid == NULL) { return -1; }
	return strtol(cpid + 5, NULL, 16);
}

int dfu_serial_number_get_bdid(char *serial) {
	char *bdid = strstr(serial, "BDID:");
	if (bdid == NULL) { return -1; }
	return strtol(bdid + 5, NULL, 16);
}

bool dfu_serial_number_is_in_dfu_mode(char *serial) {
	char *DFU = strstr(serial, "SRTG");
	return DFU != NULL;
}

bool dfu_serial_number_is_pwned(char *serial) {
	char *pwnd = strstr(serial, "PWND:");
	return pwnd != NULL;
}

bool dfu_serial_number_is_in_yolo_dfu(char *serial) {
	char *yolo = strstr(serial, "YOLO");
	return yolo != NULL;
}

bool device_serial_number_is_in_pongo_os(char *serial) {
	char *pongo = strstr(serial, "SRTG:[PongoOS");
	return pongo != NULL;
}

// palera1n-based DFU helper

bool dfu_device_found = false;

#define NOHOME (cpid == 0x8015 || (cpid == 0x8010 && (bdid == 0x08 || bdid == 0x0a || bdid == 0x0c || bdid == 0x0e)))
void dfu_helper(usb_handle_t *handle) {
	char *serialNumber = get_usb_device_serial_number(handle);
	if (serialNumber == NULL) {
		LOG(LOG_ERROR, "Failed to get device serial number.");
		close_usb_handle(handle);
		return;
	}

	int cpid = dfu_serial_number_get_cpid(serialNumber);
	if (cpid < 0) {
		LOG(LOG_ERROR, "Failed to get device CPID.");
		free(serialNumber);
		close_usb_handle(handle);
		return;
	}

	int bdid = dfu_serial_number_get_bdid(serialNumber);
	if (bdid < 0) {
		LOG(LOG_ERROR, "Failed to get device BDID.");
		free(serialNumber);
		return;
	}

	if (handle->pid != 0x1281) {
		LOG(LOG_ERROR, "Device is not in recovery mode.");
		free(serialNumber);
		return;
	}

	LOG_NO_NEWLINE(LOG_INFO, "Press enter when ready to put device into DFU mode");
	getchar();

	step(3, 0, "Get ready...");

	if (NOHOME) {
		step(4, 2, "Hold volume down + side button");
	} else {
		step(4, 2, "Hold home + power button");
	}

	send_command_to_recovery_mode(handle, "setenv auto-boot true");
	sleep_ms(100);
	send_command_to_recovery_mode(handle, "saveenv");
	sleep_ms(100);
	send_command_to_recovery_mode(handle, "reboot");

	if (NOHOME) {
		step(2, 0, "Hold volume down + side button");
		step(10, 0, "Hold volume down button");
		if (dfu_device_found) { return; }
	} else {
		step(2, 0, "Hold home + power button");
		step(10, 0, "Hold home button");
		if (dfu_device_found) { return; }
	}
	
}

extern bool stopThreads;

bool get_device_into_dfu_mode(usb_handle_t *handle) {
	pthread_t dfu_thread;
    usb_handle_t dfu_handle;
    init_usb_handle(&dfu_handle, 0x5AC, 0x1227);
	if (pthread_create(&dfu_thread, NULL, (void *)wait_usb_handle, &dfu_handle)) {
        LOG(LOG_ERROR, "Failed to create DFU thread!");
        return false;
    }

	pthread_t dfu_helper_thread;
	if (pthread_create(&dfu_helper_thread, NULL, (void *)dfu_helper, handle)) {
		LOG(LOG_ERROR, "Failed to create DFU helper thread!");
		return false;
	}

	pthread_detach(dfu_thread);
	pthread_detach(dfu_helper_thread);

	unsigned totalTime = 0;
	while (true) {
		sleep_ms(200);
		totalTime += 200;
		if (dfu_handle.device) {
			handle = &dfu_handle;
			puts("");
			dfu_device_found = true;
			stopThreads = true;
			break;
		}
		if (totalTime >= 22500) {
			puts("");
			LOG(LOG_ERROR, "Device failed to enter DFU mode.");
			stopThreads = true;
			return false;
		}
	}
	sleep_ms(200);
	stopThreads = false;
	return true;
}